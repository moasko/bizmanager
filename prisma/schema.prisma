generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ====================================
   ENUMS
======================================*/

enum SaleType {
  RETAIL
  WHOLESALE
  CREDIT
  CASH
}

enum PaymentStatus {
  PAID
  UNPAID
  PARTIAL
}

enum PaymentMethod {
  CASH
  CARD
  MOBILE_MONEY
  BANK_TRANSFER
  OTHER
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum BusinessType {
  SHOP
  RESTAURANT
  PHARMACY
  SERVICE
  OTHER
}

/* ====================================
   BUSINESS
======================================*/

model Business {
  id        String        @id @default(uuid())
  name      String
  type      BusinessType
  country   String?
  city      String?
  currency  String?       @default("XOF")
  logoUrl   String?
  settings  Json?         // taxes, POS config, invoice prefix…

  sales       Sale[]
  expenses    Expense[]
  products    Product[]
  clients     Client[]
  suppliers   Supplier[]
  users       User[]      @relation("ManagedBusinesses")
  extensionData ExtensionData[] // Relation inverse pour les données d'extensions

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?

  @@index([name])
}

/* ====================================
   SALE
======================================*/

model Sale {
  id            String        @id @default(uuid())
  reference     String        @unique   // numéro facture
  date          DateTime      @default(now())

  clientId      String?
  client        Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)

  productId     String?
  product       Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)

  productName   String
  quantity      Int           @default(1)
  unitPrice     Int           @default(0)
  discount      Int           @default(0)
  tax           Int           @default(0)
  total         Int           @default(0)
  profit        Int           @default(0)

  saleType      SaleType
  paymentStatus PaymentStatus
  paymentMethod PaymentMethod

  businessId    String
  business      Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  userId        String?
  user          User?         @relation(fields: [userId], references: [id])

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  @@index([businessId])
  @@index([clientId])
  @@index([date])
}

/* ====================================
   EXPENSE
======================================*/

model Expense {
  id            String        @id @default(uuid())
  reference     String?
  date          DateTime      @default(now())
  category      String
  description   String
  amount        Int           @default(0)
  paymentMethod PaymentMethod

  receiptUrl    String?       // preuve

  approvedById  String?
  approvedBy    User?         @relation(fields: [approvedById], references: [id])

  businessId    String
  business      Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  @@index([businessId])
  @@index([category])
}

/* ====================================
   PRODUCT
======================================*/

model Product {
  id             String       @id @default(uuid())
  name           String
  description    String?
  category       String
  sku            String?      @unique
  barcode        String?      @unique
  stock          Int          @default(0)
  minStock       Int          @default(0)
  
  costPrice      Int          @default(0)
  retailPrice    Int          @default(0)
  wholesalePrice Int          @default(0)
  purchasePrice  Int          @default(0)
  
  images         Json?        // tableau d'images
  
  supplierId     String?
  supplier       Supplier?    @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  
  businessId     String
  business       Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  sales          Sale[]
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?
  
  @@index([businessId])
  @@index([category])
}

/* ====================================
   CLIENT
======================================*/

model Client {
  id               String      @id @default(uuid())
  name             String
  contact          String
  telephone        String?
  balance          Int         @default(0)
  email            String?
  address          String?
  company          String?
  notes            String?
  loyaltyPoints    Int         @default(0)
  lastPurchaseDate DateTime?

  businessId       String
  business         Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  sales            Sale[]

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  deletedAt        DateTime?

  @@index([businessId])
  @@index([email])
  @@index([name])
}

/* ====================================
   SUPPLIER
======================================*/

model Supplier {
  id           String      @id @default(uuid())
  name         String
  product      String
  contacts     String?
  email        String?
  telephone    String?
  address      String?
  description  String?
  productTypes String?
  rating       Int?        // evaluation
  notes        String?

  businessId   String
  business     Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  products     Product[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  deletedAt    DateTime?

  @@index([businessId])
  @@index([name])
}

/* ====================================
   USER
======================================*/

model User {
  id                String        @id @default(uuid())
  name              String
  email             String        @unique
  password          String?
  role              UserRole
  status            UserStatus    @default(ACTIVE)
  avatarUrl         String?
  lastLogin         DateTime?
  permissions       Json?         // granular permission system

  managedBusinesses Business[]    @relation("ManagedBusinesses")
  extensionData     ExtensionData[] // Relation inverse pour les données d'extensions

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?

  @@index([email])
  auditLogs AuditLog[]
  expenses Expense[]
  sales Sale[]
}

/* ====================================
   AUDIT LOGS
======================================*/

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  details   Json?
  createdAt DateTime @default(now())

  @@index([userId])
}

/* ====================================
   EXTENSION DATA
======================================*/

model ExtensionData {
  id           String    @id @default(uuid())
  extensionId  String
  businessId   String
  userId       String?   // Pour assigner à un utilisateur spécifique
  key          String    // Nom de la clé de données (ex: 'wifiSales')
  data         Json      // Données JSON de l'extension
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  business     Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user         User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([extensionId])
  @@index([businessId])
  @@index([userId])
  @@unique([extensionId, businessId, key])
}


